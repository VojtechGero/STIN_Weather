@using STIN_Weather.WeatherReportUtils
@using STIN_Weather.Data

@if (data is not null)
{
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Max Temp. (C)</th>
                <th>Precipitation sum</th>
                <th>Weather Code</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < data.daily.time.Length;i++)
            {
                <tr>
                    <td>@dates[i]</td>
                    <td>@data.daily.temperature_2m_max[i]</td>
                    <td>@data.daily.precipitation_sum[i]</td>
                    <td>@WeatherUtils.ParseCode(data.daily.weather_code[i])</td>
                </tr>
            }
        </tbody>
    </table>
}
@if (error)
{
    <p>No data for chosen coordinates</p>
}


@code
{
    [Parameter]
    public Coordinates c {get; set;}
    [Parameter]
    public int historic { get; set; } = 0;
    WeatherData? data { get; set; }
    WeatherApi api { get; set; }
    RequestBuilder builder;
    bool error = false;
    List<string> dates=new List<string>();
    protected override async Task OnInitializedAsync()
    {
        api = new WeatherApi();
    }
    protected override async Task OnParametersSetAsync()
    {
        builder = new RequestBuilder(c)
            .DailyWeatherCode()
            .DailyTemperatureMax()
            .DailyPrecipitationSum()
            .HistoricDays(historic);
        try
        {
            data = await api.requestWeather(builder.GetRequest());
            DateOnly today = DateOnly.FromDateTime(DateTime.Now);
            foreach (var d in data.daily.time)
            {
                DateOnly date = DateOnly.Parse(d);
                string s = $"{date} ({date.DayOfWeek.ToString().Substring(0,3)})";
                if (date == today)
                {
                    s += " (Today)";
                }
                dates.Add(s);
            }
            error = false;
        }
        catch (HttpRequestException)
        {
            data = null;
            error = true;
        }
        finally
        {
            await base.OnParametersSetAsync();
        }
    }
    
}